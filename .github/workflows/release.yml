name: release

on:
  push:
    tags:
      - '[0-9]+.[0-9]+.[0-9]+'

permissions:
  contents: write

jobs:
  build:
    name: Build artifacts
    runs-on: ubuntu-latest
    strategy:
      fail-fast: false
      matrix:
        target:
          - { goos: linux, goarch: amd64, ext: "", name: "linux-amd64" }
          - { goos: linux, goarch: arm64, ext: "", name: "linux-arm64" }
          - { goos: windows, goarch: amd64, ext: ".exe", name: "windows-amd64" }

    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: gofmt
        run: |
          gofmt -w .
          git diff --exit-code

      - name: Unit tests
        run: go test ./...

      - name: Vet
        run: go vet ./...

      - name: Build
        env:
          GOOS: ${{ matrix.target.goos }}
          GOARCH: ${{ matrix.target.goarch }}
          CGO_ENABLED: 0
        run: go build -trimpath -ldflags "-s -w" -o "totp-${{ matrix.target.name }}${{ matrix.target.ext }}" ./

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: totp-${{ matrix.target.name }}
          path: totp-${{ matrix.target.name }}${{ matrix.target.ext }}
          if-no-files-found: error

  macos-universal:
    name: Build macOS universal binary
    runs-on: macos-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-go@v5
        with:
          go-version: stable

      - name: gofmt
        run: |
          gofmt -w .
          git diff --exit-code

      - name: Unit tests
        run: go test ./...

      - name: Vet
        run: go vet ./...

      - name: Build (arm64)
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: arm64
        run: go build -trimpath -ldflags "-s -w" -o totp-arm64 ./

      - name: Build (amd64)
        env:
          CGO_ENABLED: 1
          GOOS: darwin
          GOARCH: amd64
        run: go build -trimpath -ldflags "-s -w" -o totp-amd64 ./

      - name: Lipo (universal)
        run: lipo -create totp-amd64 totp-arm64 -output totp-macos-universal

      - name: Upload artifact
        uses: actions/upload-artifact@v4
        with:
          name: totp-macos-universal
          path: totp-macos-universal
          if-no-files-found: error

  release:
    name: Create GitHub Release
    needs: [build, macos-universal]
    runs-on: ubuntu-latest
    steps:
      - name: Download artifacts
        uses: actions/download-artifact@v4
        with:
          path: dist

      - name: Flatten dist
        run: |
          mkdir -p out
          find dist -type f -maxdepth 2 -exec cp {} out/ \;
          ls -la out

      - name: Create release
        uses: softprops/action-gh-release@v2
        with:
          files: out/*
          generate_release_notes: true
